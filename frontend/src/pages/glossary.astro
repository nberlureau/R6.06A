---
// src/pages/index.astro
import "../styles/global.css";
import "../styles/style.css";
---

<!doctype html>
<html lang="fr">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>GlossAI - Glossary</title>
    </head>

    <body class="bg-gray-50">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 px-8 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <a href="/" class="text-gray-600 hover:text-gray-900">
                        <svg
                            class="w-6 h-6"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                    </a>
                    <img
                        src="static/logo.png"
                        alt="GlossAI Logo"
                        width="200px"
                    />
                </div>
                <div class="flex gap-3">
                    <!-- Bouton Export uniquement -->
                    <button
                        id="exportBtn"
                        class="bg-primary hover-bg-primary text-white px-6 py-2 rounded-lg font-medium transition-colors"
                    >
                        Export
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="px-8 py-8">
            <div class="max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2
                        class="text-3xl font-semibold text-gray-900"
                        id="glossaryTitle"
                    >
                    </h2>
                    <button
                        id="addTermBtn"
                        class="bg-primary hover-bg-primary text-white px-6 py-2.5 rounded-lg font-medium transition-colors"
                    >
                        + New word
                    </button>
                </div>

                <!-- Table -->
                <div
                    class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden"
                >
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th
                                    class="px-6 py-4 text-left text-sm font-semibold text-gray-900"
                                    >Word</th
                                >
                                <th
                                    class="px-6 py-4 text-left text-sm font-semibold text-gray-900"
                                    >Definition</th
                                >
                                <th
                                    class="px-6 py-4 text-left text-sm font-semibold text-gray-900"
                                    >Synonyms</th
                                >
                                <th
                                    class="px-6 py-4 text-left text-sm font-semibold text-gray-900"
                                    >Actions</th
                                >
                            </tr>
                        </thead>
                        <tbody
                            id="glossaryTable"
                            class="divide-y divide-gray-200"
                        >
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <!-- Modal Add/Edit Term -->
        <div id="modal" class="hidden fixed inset-0 z-50">
            <div
                class="modal-overlay absolute inset-0 bg-opacity-30 backdrop-blur-sm"
                id="modalOverlay"
            >
            </div>
            <div class="flex items-center justify-center min-h-screen p-4">
                <div
                    class="modal-content bg-white rounded-3xl shadow-2xl max-w-4xl w-full p-10 relative"
                >
                    <h3
                        class="text-2xl font-semibold text-gray-900 mb-8"
                        id="modalTitle"
                    >
                        Addition of a new word
                    </h3>

                    <div
                        class="bg-gray-50 rounded-2xl p-8 space-y-6 border border-gray-100"
                    >
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">
                            Word details
                        </h4>

                        <div>
                            <label
                                class="block text-sm font-medium text-gray-900 mb-2"
                            >
                                Word <span class="text-red-600">*</span>
                            </label>
                            <input
                                type="text"
                                id="termInput"
                                placeholder="Enter the word"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none transition-all bg-white"
                            />
                            <p
                                id="termError"
                                class="text-red-600 text-sm mt-1 hidden"
                            >
                                This field is required!
                            </p>
                        </div>

                        <div>
                            <label
                                class="block text-sm font-medium text-gray-900 mb-2"
                            >
                                Definition <span class="text-red-600">*</span>
                            </label>
                            <textarea
                                id="definitionInput"
                                placeholder="Enter the definition of the word"
                                rows="4"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none transition-all resize-none bg-white"
                            ></textarea>
                            <p
                                id="definitionError"
                                class="text-red-600 text-sm mt-1 hidden"
                            >
                                This field is required!
                            </p>
                        </div>

                        <div>
                            <label
                                class="block text-sm font-medium text-gray-900 mb-2"
                            >
                                Synonym
                                <!-- Point d'interrogation avec tooltip -->
                                <span class="inline-block relative group ml-1">
                                    <svg
                                        class="w-4 h-4 text-gray-900 cursor-help"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="1 0 24 19"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                                        >
                                        </path>
                                    </svg>
                                    <!-- Tooltip qui apparaît au hover -->
                                    <div
                                        class="hidden group-hover:block absolute z-10 w-64 p-3 bg-gray-900 text-white text-sm rounded-lg shadow-lg
                        -top-2 left-6 transform -translate-y-full"
                                    >
                                        <div class="relative">
                                            <div
                                                class="absolute -left-2 top-1/2 transform -translate-y-1/2"
                                            >
                                                <div
                                                    class="w-2 h-2 bg-gray-900 rotate-45"
                                                >
                                                </div>
                                            </div>
                                            <p class="font-medium mb-1">
                                                About Synonyms
                                            </p>
                                            <p
                                                id="synonymTooltipText"
                                                class="text-gray-300"
                                            >
                                                To add Synonyms, type the word
                                                in the input field and press
                                                Enter. For the AI suggestions,
                                                just click on the suggested
                                                synonym you want to add it.
                                            </p>
                                        </div>
                                    </div>
                                </span>
                            </label>

                            <div class="flex items-center gap-2 flex-wrap">
                                <input
                                    type="text"
                                    id="synonymInput"
                                    placeholder="Enter synonyms for the word"
                                    class="w-48 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none transition-all bg-white text-sm"
                                />
                                <!-- Tags container inline -->
                                <div
                                    id="synonymTags"
                                    class="flex flex-wrap gap-2"
                                >
                                </div>
                            </div>
                            <p
                                id="synonymError"
                                class="text-red-600 text-sm mt-1 hidden"
                            >
                            </p>

                            <button
                                id="suggestBtn"
                                class="mt-3 px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors bg-white"
                            >
                                AI Suggestions
                            </button>

                            <!-- Conteneur pour les suggestions IA -->
                            <div
                                id="aiSuggestionsContainer"
                                class="mt-2 flex flex-wrap gap-2 hidden"
                            >
                                <!-- Les suggestions IA seront insérées ici -->
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 mt-8">
                        <button
                            id="cancelBtn"
                            class="px-8 py-3 border border-gray-300 rounded-lg font-medium text-gray-900 hover:bg-gray-50 transition-colors"
                        >
                            Cancel
                        </button>
                        <button
                            id="submitBtn"
                            class="px-8 py-3 bg-primary hover-bg-primary text-white rounded-lg font-medium transition-colors"
                        >
                            Add
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Export -->
        <div id="exportModal" class="hidden fixed inset-0 z-50">
            <div
                class="modal-overlay absolute inset-0 bg-opacity-30 backdrop-blur-sm"
                id="exportModalOverlay"
            >
            </div>
            <div class="flex items-center justify-center min-h-screen p-4">
                <div
                    class="modal-content bg-gray-100 rounded-3xl shadow-2xl max-w-5xl w-full p-10 relative"
                >
                    <h3 class="text-4xl font-bold text-gray-900 mb-8">
                        Export
                    </h3>

                    <div class="bg-white rounded-2xl p-8 shadow-sm">
                        <!-- Preview section header with tabs -->
                        <div class="flex justify-between items-center mb-6">
                            <h4 class="text-xl font-semibold text-gray-900">
                                Preview of the file
                            </h4>
                            <div class="flex gap-2 bg-gray-200 p-1 rounded-lg">
                                <button
                                    id="previewMarkdownBtn"
                                    class="px-6 py-2 rounded-md font-medium transition-colors bg-white text-gray-900 shadow-sm"
                                >
                                    Markdown
                                </button>
                                <button
                                    id="previewJsonBtn"
                                    class="px-6 py-2 rounded-md font-medium transition-colors text-gray-600 hover:text-gray-900"
                                >
                                    json
                                </button>
                            </div>
                        </div>

                        <!-- Preview content -->
                        <div
                            id="exportPreview"
                            class="bg-gray-50 border border-gray-200 rounded-xl p-6 min-h-[400px] max-h-[400px] overflow-auto font-mono text-sm whitespace-pre-wrap text-gray-700"
                        >
                            <!-- Preview content will appear here -->
                            <p class="text-gray-400 text-center py-20">
                                Select a format to preview
                            </p>
                        </div>
                    </div>

                    <!-- Export buttons -->
                    <div class="flex gap-4 mt-8 justify-center">
                        <button
                            id="exportMarkdownBtn"
                            class="bg-primary hover-bg-primary text-white px-10 py-4 rounded-xl font-semibold transition-colors text-lg shadow-lg"
                        >
                            Download Markdown
                        </button>
                        <button
                            id="exportJsonBtn"
                            class="bg-primary hover-bg-primary text-white px-10 py-4 rounded-xl font-semibold transition-colors text-lg shadow-lg"
                        >
                            Download JSON
                        </button>
                    </div>

                    <div class="flex justify-center mt-6">
                        <button
                            id="exportCancelBtn"
                            class="px-8 py-3 border border-gray-300 rounded-xl font-medium text-gray-900 hover:bg-gray-50 transition-colors"
                        >
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // ===== VARIABLES GLOBALES =====
            const urlParams = new URLSearchParams(window.location.search);
            const glossaryId = parseInt(urlParams.get("id"));

            // Charger le glossaire spécifique
            const glossaries =
                JSON.parse(localStorage.getItem("glossaries")) || [];
            const currentGlossary = glossaries.find((g) => g.id === glossaryId);

            if (!currentGlossary) {
                // Si le glossaire n'existe pas, rediriger vers l'accueil
                window.location.href = "/";
            }

            let terms = currentGlossary ? currentGlossary.terms : [];
            let nextId = Math.max(...terms.map((t) => t.id), 0) + 1;
            let currentSynonyms = [];
            let currentPreviewFormat = null;
            let aiSuggestions = [];
            let currentEditingId = null;
            let deleteUtils = null;

            // ===== ÉLÉMENTS DU DOM =====
            // Modal Export elements
            const exportModal = document.getElementById("exportModal");
            const exportBtn = document.getElementById("exportBtn");
            const exportCancelBtn = document.getElementById("exportCancelBtn");
            const exportModalOverlay =
                document.getElementById("exportModalOverlay");
            const exportMarkdownBtn =
                document.getElementById("exportMarkdownBtn");
            const exportJsonBtn = document.getElementById("exportJsonBtn");
            const previewMarkdownBtn =
                document.getElementById("previewMarkdownBtn");
            const previewJsonBtn = document.getElementById("previewJsonBtn");
            const exportPreview = document.getElementById("exportPreview");

            // Modal Add Term elements
            const modal = document.getElementById("modal");
            const addTermBtn = document.getElementById("addTermBtn");
            const cancelBtn = document.getElementById("cancelBtn");
            const submitBtn = document.getElementById("submitBtn");
            const modalOverlay = document.getElementById("modalOverlay");
            const suggestBtn = document.getElementById("suggestBtn");
            const synonymInput = document.getElementById("synonymInput");
            const modalTitle = document.getElementById("modalTitle");
            const glossaryTable = document.getElementById("glossaryTable");

            // ===== FONCTIONS DE BASE =====
            function saveTerms() {
                // Mettre à jour les termes du glossaire actuel
                const glossaries =
                    JSON.parse(localStorage.getItem("glossaries")) || [];
                const glossaryIndex = glossaries.findIndex(
                    (g) => g.id === glossaryId,
                );

                if (glossaryIndex !== -1) {
                    glossaries[glossaryIndex].terms = terms;
                    localStorage.setItem(
                        "glossaries",
                        JSON.stringify(glossaries),
                    );
                }
            }

            function renderTable() {
                const tbody = document.getElementById("glossaryTable");

                // Fonction utilitaire pour couper un texte
                const shorten = (t) =>
                    typeof t === "string" && t.length > 20
                        ? t.slice(0, 20) + "..."
                        : t;

                tbody.innerHTML = terms
                    .map(
                        (term) => `
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-6 py-4 font-medium text-gray-900">
                                    ${shorten(term.term)}
                                </td>
                                <td class="px-6 py-4 text-gray-700">
                                    ${shorten(term.definition)}
                                </td>
                                <td class="px-6 py-4 text-gray-700">
                                    ${Array.isArray(term.synonyms) ? term.synonyms.join(", ") : term.synonyms}
                                </td>
                                <td class="px-6 py-4">
                                    <button 
                                        class="edit-btn text-blue-600 hover:text-blue-900 font-medium text-sm mr-4"
                                        data-id="${term.id}"
                                    >
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                        </svg>
                                    </button>
                                    <button 
                                        class="delete-btn text-red-600 hover:text-red-900 font-medium text-sm"
                                        data-id="${term.id}"
                                    >
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                        `,
                    )
                    .join("");

                // Ajouter les écouteurs d'événements pour les boutons Edit et Delete
                attachTableEventListeners();
            }

            function attachTableEventListeners() {
                // Écouteurs pour les boutons Edit
                document.querySelectorAll(".edit-btn").forEach((btn) => {
                    btn.addEventListener("click", function () {
                        const id = parseInt(this.getAttribute("data-id"));
                        editTerm(id);
                    });
                });

                // Écouteurs pour les boutons Delete
                document.querySelectorAll(".delete-btn").forEach((btn) => {
                    btn.addEventListener("click", async function (e) {
                        e.stopPropagation(); // Empêcher la redirection
                        const id = parseInt(this.getAttribute("data-id"));
                        await deleteTerm(id);
                    });
                });
            }

            function renderSynonymTags() {
                const tagsContainer = document.getElementById("synonymTags");
                tagsContainer.innerHTML = currentSynonyms
                    .map(
                        (syn, index) => `
            <span class="inline-flex items-center gap-2 px-3 py-1 bg-gray-200 text-gray-800 rounded-md text-sm">
                ${syn}
                <button type="button" class="remove-synonym text-gray-600 hover:text-gray-900 font-bold" data-index="${index}">×</button>
            </span>
        `,
                    )
                    .join("");

                // Ajouter les écouteurs d'événements pour les boutons de suppression des synonymes
                document.querySelectorAll(".remove-synonym").forEach((btn) => {
                    btn.addEventListener("click", function () {
                        const index = parseInt(this.getAttribute("data-index"));
                        removeSynonym(index);
                    });
                });
            }

            // ===== FONCTIONS DE MODIFICATION =====
            function editTerm(id) {
                const term = terms.find((t) => t.id === id);
                if (!term) return;

                currentEditingId = id;

                // Remplir le modal avec les données existantes
                document.getElementById("termInput").value = term.term;
                document.getElementById("definitionInput").value =
                    term.definition;
                currentSynonyms = Array.isArray(term.synonyms)
                    ? [...term.synonyms]
                    : [];

                renderSynonymTags();

                // Changer le titre et le bouton du modal
                modalTitle.textContent = "Edit word";
                submitBtn.textContent = "Update";

                openModal();
            }

            async function deleteTerm(id) {
                const utils = await loadDeleteUtils();
                const success = await utils.deleteTerm(glossaryId, id, () => {
                    // Mettre à jour la liste locale
                    terms = terms.filter((t) => t.id !== id);
                    saveTerms();
                    renderTable();
                    showSuccessMessage("Term deleted successfully!");
                });
            }

            function removeSynonym(index) {
                currentSynonyms.splice(index, 1);
                renderSynonymTags();
            }

            // ===== FONCTIONS D'EXPORT =====
            function getExportData() {
                return {
                    glossary: {
                        name: currentGlossary.name,
                        description: currentGlossary.description,
                        createdAt: new Date().toISOString(),
                        termCount: terms.length,
                    },
                    terms: terms.map((term) => [
                        term.term,
                        term.definition,
                        Array.isArray(term.synonyms) ? term.synonyms : [],
                    ]),
                };
            }

            async function updatePreview(format) {
                try {
                    const { generateMarkdownString, generateJSONString } =
                        await import("../lib/export_documents.js");
                    const exportData = getExportData();
                    let previewContent = "";

                    if (format === "markdown") {
                        previewContent = generateMarkdownString(
                            exportData.terms,
                            ["Word", "Definition", "Synonyms"],
                            exportData.glossary.name,
                            exportData.glossary.description,
                        );
                    } else if (format === "json") {
                        previewContent = generateJSONString(
                            exportData.terms,
                            ["Word", "Definition", "Synonyms"],
                            exportData.glossary.name,
                            exportData.glossary.description,
                        );
                    }

                    exportPreview.textContent = previewContent;
                    currentPreviewFormat = format;

                    // Mettre à jour les styles des boutons de prévisualisation
                    if (format === "markdown") {
                        previewMarkdownBtn.classList.remove(
                            "text-gray-600",
                            "hover:text-gray-900",
                        );
                        previewMarkdownBtn.classList.add(
                            "bg-white",
                            "text-gray-900",
                            "shadow-sm",
                        );
                        previewJsonBtn.classList.remove(
                            "bg-white",
                            "text-gray-900",
                            "shadow-sm",
                        );
                        previewJsonBtn.classList.add(
                            "text-gray-600",
                            "hover:text-gray-900",
                        );
                    } else {
                        previewJsonBtn.classList.remove(
                            "text-gray-600",
                            "hover:text-gray-900",
                        );
                        previewJsonBtn.classList.add(
                            "bg-white",
                            "text-gray-900",
                            "shadow-sm",
                        );
                        previewMarkdownBtn.classList.remove(
                            "bg-white",
                            "text-gray-900",
                            "shadow-sm",
                        );
                        previewMarkdownBtn.classList.add(
                            "text-gray-600",
                            "hover:text-gray-900",
                        );
                    }
                } catch (error) {
                    console.error("Preview error:", error);
                    exportPreview.textContent =
                        "Error generating preview: " + error.message;
                }
            }

            async function loadDeleteUtils() {
                if (!deleteUtils) {
                    const { DeleteUtils } = await import(
                        "../lib/deleteUtils.js"
                    );
                    deleteUtils = new DeleteUtils();
                }
                return deleteUtils;
            }

            // ===== FONCTIONS DE MODALES =====
            function openExportModal() {
                exportModal.classList.remove("hidden");
                document.body.style.overflow = "hidden";
                exportPreview.innerHTML =
                    '<p class="text-gray-400 text-center py-20">Select a format to preview</p>';
                currentPreviewFormat = null;

                // Reset preview button styles
                previewMarkdownBtn.classList.remove(
                    "text-gray-600",
                    "hover:text-gray-900",
                );
                previewMarkdownBtn.classList.add(
                    "bg-white",
                    "text-gray-900",
                    "shadow-sm",
                );
                previewJsonBtn.classList.remove(
                    "bg-white",
                    "text-gray-900",
                    "shadow-sm",
                );
                previewJsonBtn.classList.add(
                    "text-gray-600",
                    "hover:text-gray-900",
                );
            }

            function closeExportModal() {
                exportModal.classList.add("hidden");
                document.body.style.overflow = "auto";
            }

            function openModal() {
                modal.classList.remove("hidden");
                document.body.style.overflow = "hidden";
            }

            function closeModal() {
                modal.classList.add("hidden");
                document.body.style.overflow = "auto";

                // Réinitialiser le formulaire
                document.getElementById("termInput").value = "";
                document.getElementById("definitionInput").value = "";
                document.getElementById("synonymInput").value = "";
                currentSynonyms = [];
                aiSuggestions = [];
                renderSynonymTags();
                document
                    .getElementById("aiSuggestionsContainer")
                    .classList.add("hidden");
                clearErrors();

                // Réinitialiser le mode édition
                currentEditingId = null;
                modalTitle.textContent = "Addition of a new word";
                submitBtn.textContent = "Add";
            }

            // ===== FONCTIONS UTILITAIRES =====
            function clearErrors() {
                document.getElementById("termError").classList.add("hidden");
                document
                    .getElementById("definitionError")
                    .classList.add("hidden");
                document.getElementById("synonymError").classList.add("hidden");
                document
                    .getElementById("termInput")
                    .classList.remove("border-red-500");
                document
                    .getElementById("definitionInput")
                    .classList.remove("border-red-500");
                document
                    .getElementById("synonymInput")
                    .classList.remove("border-red-500");
            }

            // ===== FONCTIONS POUR LES SYNONYMES =====
            function addSynonymFromInput() {
                const synonymInput = document.getElementById("synonymInput");
                const termInput = document.getElementById("termInput");
                const synonymError = document.getElementById("synonymError");
                const synonym = synonymInput.value.trim();
                const term = termInput.value.trim();

                synonymError.classList.add("hidden");
                synonymInput.classList.remove("border-red-500");

                if (!synonym) return;

                if (synonym.toLowerCase() === term.toLowerCase()) {
                    synonymError.textContent =
                        "The synonym cannot be identical to the term!";
                    synonymError.classList.remove("hidden");
                    synonymInput.classList.add("border-red-500");
                    return;
                }

                if (currentSynonyms.includes(synonym)) {
                    synonymError.textContent =
                        "This synonym has already been added!";
                    synonymError.classList.remove("hidden");
                    synonymInput.classList.add("border-red-500");
                    return;
                }

                currentSynonyms.push(synonym);
                renderSynonymTags();
                synonymInput.value = "";
            }

            // ===== FONCTIONS POUR LES SUGGESTIONS IA =====
            function renderAISuggestions() {
                const container = document.getElementById(
                    "aiSuggestionsContainer",
                );
                if (aiSuggestions.length === 0) {
                    container.classList.add("hidden");
                    return;
                }

                const availableSuggestions = aiSuggestions.filter(
                    (synonym) => !currentSynonyms.includes(synonym),
                );

                const randomSuggestions = availableSuggestions
                    .sort(() => 0.5 - Math.random())
                    .slice(0, 5);

                if (randomSuggestions.length === 0) {
                    container.classList.add("hidden");
                    return;
                }

                container.innerHTML = randomSuggestions
                    .map(
                        (synonym) => `
            <button 
                type="button" 
                class="inline-flex items-center gap-1 px-3 py-1 bg-blue-100 text-blue-800 rounded-md text-sm hover:bg-blue-200 transition-colors ai-suggestion-btn"
                data-synonym="${synonym.replace(/"/g, "&quot;")}"
            >
                ${synonym}
                <span class="text-blue-600 text-xs">+</span>
            </button>
        `,
                    )
                    .join("");

                container.classList.remove("hidden");

                document
                    .querySelectorAll(".ai-suggestion-btn")
                    .forEach((btn) => {
                        btn.addEventListener("click", function () {
                            const synonym = this.getAttribute("data-synonym");
                            addAISuggestion(synonym);
                        });
                    });
            }

            function addAISuggestion(synonym) {
                const termInput = document.getElementById("termInput");
                const term = termInput.value.trim();

                if (synonym.toLowerCase() === term.toLowerCase()) {
                    return;
                }

                if (!currentSynonyms.includes(synonym)) {
                    currentSynonyms.push(synonym);
                    renderSynonymTags();
                    renderAISuggestions();
                }
            }

            const { invoke } = window.__TAURI__.core;
            async function fetchAISuggestions() {
                const termInput = document.getElementById("termInput");
                const definitionInput = document.getElementById("definitionInput");
                const synonymInput = document.getElementById("synonymInput");
                const suggestBtn = document.getElementById("suggestBtn");
                const aiSuggestionsContainer = document.getElementById("aiSuggestionsContainer");

                const term = termInput.value.trim();
                const definition = definitionInput.value.trim() || null;
                const synonyms = [...currentSynonyms, synonymInput.value.trim()].filter(s => s);

                if (!term) {
                    showErrorMessage("Please enter a word first.");
                    termInput.focus();
                    return;
                }

                // Get glossary name and description from currentGlossary
                const glossaryName = currentGlossary ? currentGlossary.name : "";
                const glossaryDescription = currentGlossary ? currentGlossary.description : "";

                // Get all terms from the glossary for context (just the words)
                const contextTerms = terms.map(t => t.term);

                const originalText = suggestBtn.textContent;
                suggestBtn.textContent = "Searching...";
                suggestBtn.disabled = true;
                aiSuggestionsContainer.classList.add("hidden");

                try {
                    aiSuggestions = await invoke("suggest_synonyms", {
                        term,
                        definition,
                        synonyms,
                        glossaryName,
                        glossaryDescription,
                        context: contextTerms
                    });

                    if (aiSuggestions.length > 0) {
                        renderAISuggestions();
                        showSuccessMessage(`${aiSuggestions.length} suggestions found`);
                    } else {
                        showInfoMessage("No synonyms found for this word");
                    }
                } catch (error) {
                    console.error("Error:", error);
                    showErrorMessage("Error: " + (error?.message || error?.toString() || "Failed to find suggestions"));
                    aiSuggestions = [];
                } finally {
                    suggestBtn.textContent = originalText;
                    suggestBtn.disabled = false;
                }
            }

            // ===== FONCTIONS DE MESSAGES =====
            function showSuccessMessage(message) {
                showMessage(
                    message,
                    "bg-green-100 border-green-400 text-green-700",
                );
            }

            function showErrorMessage(message) {
                showMessage(message, "bg-red-100 border-red-400 text-red-700");
            }

            function showInfoMessage(message) {
                showMessage(
                    message,
                    "bg-blue-100 border-blue-400 text-blue-700",
                );
            }

            function showMessage(message, styles) {
                let toast = document.getElementById("aiToast");
                if (!toast) {
                    toast = document.createElement("div");
                    toast.id = "aiToast";
                    toast.className = `fixed top-4 right-4 border rounded-lg shadow-lg p-4 z-50 transition-opacity duration-300 ${styles}`;
                    document.body.appendChild(toast);
                }

                toast.innerHTML = `
            <div class="flex items-center gap-3">
                <div class="flex-1">
                    <p class="font-medium">${message}</p>
                </div>
                <button type="button" class="close-toast text-gray-500 hover:text-gray-700">
                    ×
                </button>
            </div>
        `;

                // Ajouter l'écouteur d'événement pour fermer le toast
                toast
                    .querySelector(".close-toast")
                    .addEventListener("click", function () {
                        toast.remove();
                    });

                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.remove();
                    }
                }, 5000);
            }

            // ===== ÉCOUTEURS D'ÉVÉNEMENTS =====

            // Export events
            exportBtn.addEventListener("click", openExportModal);
            exportCancelBtn.addEventListener("click", closeExportModal);
            exportModalOverlay.addEventListener("click", closeExportModal);
            previewMarkdownBtn.addEventListener("click", () =>
                updatePreview("markdown"),
            );
            previewJsonBtn.addEventListener("click", () =>
                updatePreview("json"),
            );

            exportMarkdownBtn.addEventListener("click", async () => {
                try {
                    const { generateMarkdown } = await import(
                        "../lib/export_documents.js"
                    );
                    const exportData = getExportData();
                    generateMarkdown(
                        exportData.terms,
                        ["Word", "Definition", "Synonyms"],
                        exportData.glossary.name,
                        exportData.glossary.description,
                    );
                    closeExportModal();
                    showSuccessMessage("Glossary exported as Markdown!");
                } catch (error) {
                    console.error("Export error:", error);
                    showErrorMessage(
                        "Error exporting glossary: " + error.message,
                    );
                }
            });

            exportJsonBtn.addEventListener("click", async () => {
                try {
                    const { generateJSON } = await import(
                        "../lib/export_documents.js"
                    );
                    const exportData = getExportData();
                    generateJSON(
                        exportData.terms,
                        ["Word", "Definition", "Synonyms"],
                        exportData.glossary.name,
                        exportData.glossary.description,
                    );
                    closeExportModal();
                    showSuccessMessage("Glossary exported as JSON!");
                } catch (error) {
                    console.error("Export error:", error);
                    showErrorMessage(
                        "Error exporting glossary: " + error.message,
                    );
                }
            });

            // Add term events
            addTermBtn.addEventListener("click", openModal);
            cancelBtn.addEventListener("click", closeModal);
            modalOverlay.addEventListener("click", closeModal);
            suggestBtn.addEventListener("click", fetchAISuggestions);

            synonymInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    addSynonymFromInput();
                }
            });

            synonymInput.addEventListener("input", () => {
                document.getElementById("synonymError").classList.add("hidden");
                synonymInput.classList.remove("border-red-500");
            });

            document
                .getElementById("termInput")
                .addEventListener("input", () => {
                    document
                        .getElementById("termError")
                        .classList.add("hidden");
                    document
                        .getElementById("termInput")
                        .classList.remove("border-red-500");
                });

            document
                .getElementById("definitionInput")
                .addEventListener("input", () => {
                    document
                        .getElementById("definitionError")
                        .classList.add("hidden");
                    document
                        .getElementById("definitionInput")
                        .classList.remove("border-red-500");
                });

            submitBtn.addEventListener("click", () => {
                const termInput = document.getElementById("termInput");
                const definitionInput =
                    document.getElementById("definitionInput");
                const term = termInput.value.trim();
                const definition = definitionInput.value.trim();

                clearErrors();
                let hasError = false;

                if (!term) {
                    document
                        .getElementById("termError")
                        .classList.remove("hidden");
                    termInput.classList.add("border-red-500");
                    hasError = true;
                }

                if (!definition) {
                    document
                        .getElementById("definitionError")
                        .classList.remove("hidden");
                    definitionInput.classList.add("border-red-500");
                    hasError = true;
                }

                if (hasError) return;

                if (currentEditingId) {
                    // Mode édition - mettre à jour le terme existant
                    const termIndex = terms.findIndex(
                        (t) => t.id === currentEditingId,
                    );
                    if (termIndex !== -1) {
                        terms[termIndex] = {
                            ...terms[termIndex],
                            term,
                            definition,
                            synonyms:
                                currentSynonyms.length > 0
                                    ? [...currentSynonyms]
                                    : [],
                        };
                        saveTerms();
                        renderTable();
                        closeModal();
                        showSuccessMessage("Term updated successfully!");
                    }
                } else {
                    // Mode ajout - créer un nouveau terme
                    terms.push({
                        id: nextId++,
                        term,
                        definition,
                        synonyms:
                            currentSynonyms.length > 0
                                ? [...currentSynonyms]
                                : [],
                    });
                    saveTerms();
                    renderTable();
                    closeModal();
                    showSuccessMessage("Term added successfully!");
                }
            });

            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape" && !modal.classList.contains("hidden")) {
                    closeModal();
                }
            });

            // ===== INITIALISATION =====
            document.getElementById("glossaryTitle").textContent =
                currentGlossary.name;
            document.title = `GlossAI - ${currentGlossary.name}`;
            renderTable();
        </script>
    </body>
</html>
