---
// src/pages/index.astro
import "../styles/global.css";
import "../styles/style.css";
---

<!doctype html>
<html lang="fr">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>GlossAI - Glossary</title>
    </head>

    <body class="bg-gray-50">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 px-8 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <img
                        src="static/logo.png"
                        alt="GlossAI Logo"
                        width="200px"
                    />
                    <h1 class="text-2xl font-semibold text-gray-900"></h1>
                </div>
                <div class="flex gap-3">
                    <!-- Nouveau bouton Import -->
                    <button
                        id="importBtn"
                        class="bg-primary hover-bg-primary text-white px-6 py-2 rounded-lg font-medium transition-colors"
                    >
                        Import
                    </button>
                    <!-- Bouton Export existant -->
                    <button
                        id="exportBtn"
                        class="bg-primary hover-bg-primary text-white px-6 py-2 rounded-lg font-medium transition-colors"
                    >
                        Export
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="px-8 py-8">
            <div class="max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-semibold text-gray-900">
                        Glossary
                    </h2>
                    <button
                        id="addTermBtn"
                        class="bg-primary hover-bg-primary text-white px-6 py-2.5 rounded-lg font-medium transition-colors"
                    >
                        + New word
                    </button>
                </div>

                <!-- Table -->
                <div
                    class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden"
                >
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th
                                    class="px-6 py-4 text-left text-sm font-semibold text-gray-900"
                                    >Word</th
                                >
                                <th
                                    class="px-6 py-4 text-left text-sm font-semibold text-gray-900"
                                    >Definition</th
                                >
                                <th
                                    class="px-6 py-4 text-left text-sm font-semibold text-gray-900"
                                    >Synonyms</th
                                >
                            </tr>
                        </thead>
                        <tbody
                            id="glossaryTable"
                            class="divide-y divide-gray-200"
                        >
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <!-- Modal -->
        <div id="modal" class="hidden fixed inset-0 z-50">
            <div
                class="modal-overlay absolute inset-0 bg-opacity-30 backdrop-blur-sm"
                id="modalOverlay"
            >
            </div>
            <div class="flex items-center justify-center min-h-screen p-4">
                <div
                    class="modal-content bg-white rounded-3xl shadow-2xl max-w-4xl w-full p-10 relative"
                >
                    <h3 class="text-2xl font-semibold text-gray-900 mb-8">
                        Addition of a new word
                    </h3>

                    <div
                        class="bg-gray-50 rounded-2xl p-8 space-y-6 border border-gray-100"
                    >
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">
                            Word details
                        </h4>

                        <div>
                            <label
                                class="block text-sm font-medium text-gray-900 mb-2"
                            >
                                Word <span class="text-red-600">*</span>
                            </label>
                            <input
                                type="text"
                                id="termInput"
                                placeholder="Enter the word"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none transition-all bg-white"
                            />
                            <p
                                id="termError"
                                class="text-red-600 text-sm mt-1 hidden"
                            >
                                This field is required!
                            </p>
                        </div>

                        <div>
                            <label
                                class="block text-sm font-medium text-gray-900 mb-2"
                            >
                                Definition <span class="text-red-600">*</span>
                            </label>
                            <textarea
                                id="definitionInput"
                                placeholder="Enter the definition of the word"
                                rows="4"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none transition-all resize-none bg-white"
                            ></textarea>
                            <p
                                id="definitionError"
                                class="text-red-600 text-sm mt-1 hidden"
                            >
                                This field is required!
                            </p>
                        </div>

                        <div>
                            <label
                                class="block text-sm font-medium text-gray-900 mb-2"
                            >
                                Synonym
                            </label>
                            <div class="flex items-center gap-2 flex-wrap">
                                <input
                                    type="text"
                                    id="synonymInput"
                                    placeholder="Enter synonyms for the word"
                                    class="w-48 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none transition-all bg-white text-sm"
                                />
                                <!-- Tags container inline -->
                                <div
                                    id="synonymTags"
                                    class="flex flex-wrap gap-2"
                                >
                                </div>
                            </div>
                            <p
                                id="synonymError"
                                class="text-red-600 text-sm mt-1 hidden"
                            >
                            </p>

                            <button
                                id="suggestBtn"
                                class="mt-3 px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors bg-white"
                            >
                                AI Suggestions
                            </button>

                            <!-- Conteneur pour les suggestions IA -->
                            <div
                                id="aiSuggestionsContainer"
                                class="mt-2 flex flex-wrap gap-2 hidden"
                            >
                                <!-- Les suggestions IA seront insérées ici -->
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 mt-8">
                        <button
                            id="cancelBtn"
                            class="px-8 py-3 border border-gray-300 rounded-lg font-medium text-gray-900 hover:bg-gray-50 transition-colors"
                        >
                            Cancel
                        </button>
                        <button
                            id="submitBtn"
                            class="px-8 py-3 bg-primary hover-bg-primary text-white rounded-lg font-medium transition-colors"
                        >
                            Add
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Export -->
        <div id="exportModal" class="hidden fixed inset-0 z-50">
            <div
                class="modal-overlay absolute inset-0 bg-black bg-opacity-30 backdrop-blur-sm"
                id="exportModalOverlay"
            >
            </div>
            <div class="flex items-center justify-center min-h-screen p-4">
                <div
                    class="modal-content bg-white rounded-3xl shadow-2xl max-w-md w-full p-8 relative"
                >
                    <h3 class="text-2xl font-semibold text-gray-900 mb-6">
                        Export Glossary
                    </h3>

                    <div class="space-y-4 mb-6">
                        <p class="text-gray-600">Choose the export format:</p>

                        <div class="flex gap-4">
                            <button
                                id="exportMarkdownBtn"
                                class="flex-1 bg-primary hover-bg-primary text-white px-6 py-3 rounded-lg font-medium transition-colors"
                            >
                                Markdown
                            </button>
                            <button
                                id="exportJsonBtn"
                                class="flex-1 bg-primary hover-bg-primary text-white px-6 py-3 rounded-lg font-medium transition-colors"
                            >
                                JSON
                            </button>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3">
                        <button
                            id="exportCancelBtn"
                            class="px-6 py-2 border border-gray-300 rounded-lg font-medium text-gray-900 hover:bg-gray-50 transition-colors"
                        >
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Import -->
        <div id="importModal" class="hidden fixed inset-0 z-50">
            <div
                class="modal-overlay absolute inset-0 bg-black bg-opacity-30 backdrop-blur-sm"
                id="importModalOverlay"
            >
            </div>
            <div class="flex items-center justify-center min-h-screen p-4">
                <div
                    class="modal-content bg-white rounded-3xl shadow-2xl max-w-md w-full p-8 relative"
                >
                    <h3 class="text-2xl font-semibold text-gray-900 mb-6">
                        Import Glossary
                    </h3>

                    <div class="space-y-4 mb-6">
                        <p class="text-gray-600">Choose file to import:</p>

                        <div
                            class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center"
                        >
                            <input
                                type="file"
                                id="importFileInput"
                                accept=".md,.json,.txt"
                                class="hidden"
                            />
                            <div class="flex flex-col items-center gap-3">
                                <svg
                                    class="w-12 h-12 text-gray-400"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                                    ></path>
                                </svg>
                                <p class="text-gray-600">
                                    Click to select a file
                                </p>
                                <p class="text-sm text-gray-500">
                                    Supports: .md, .json
                                </p>
                            </div>
                        </div>

                        <div
                            id="importError"
                            class="text-red-600 text-sm hidden"
                        >
                        </div>
                    </div>

                    <div class="flex justify-end gap-3">
                        <button
                            id="importCancelBtn"
                            class="px-6 py-2 border border-gray-300 rounded-lg font-medium text-gray-900 hover:bg-gray-50 transition-colors"
                        >
                            Cancel
                        </button>
                        <button
                            id="importConfirmBtn"
                            class="px-6 py-2 bg-primary hover-bg-primary text-white rounded-lg font-medium transition-colors"
                        >
                            Import
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div
            id="toast"
            class="hidden fixed top-4 right-4 bg-white border border-gray-200 rounded-lg shadow-lg p-4 z-50 toast"
        >
            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center"
                >
                    <svg
                        class="w-6 h-6 text-blue-600"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                        ></path>
                    </svg>
                </div>
                <div>
                    <p class="font-medium text-gray-900">AI Suggestions</p>
                    <p class="text-sm text-gray-600">
                        Feature under development
                    </p>
                </div>
            </div>
        </div>

        <script>
            // Modal Export elements
            const exportModal = document.getElementById("exportModal");
            const exportBtn = document.getElementById("exportBtn");
            const exportCancelBtn = document.getElementById("exportCancelBtn");
            const exportModalOverlay =
                document.getElementById("exportModalOverlay");
            const exportMarkdownBtn =
                document.getElementById("exportMarkdownBtn");
            const exportJsonBtn = document.getElementById("exportJsonBtn");

            // Modal Import elements
            const importModal = document.getElementById("importModal");
            const importBtn = document.getElementById("importBtn");
            const importCancelBtn = document.getElementById("importCancelBtn");
            const importModalOverlay =
                document.getElementById("importModalOverlay");
            const importFileInput = document.getElementById("importFileInput");
            const importConfirmBtn =
                document.getElementById("importConfirmBtn");
            const importError = document.getElementById("importError");

            // Export modal functions
            function openExportModal() {
                exportModal.classList.remove("hidden");
                document.body.style.overflow = "hidden";
            }

            function closeExportModal() {
                exportModal.classList.add("hidden");
                document.body.style.overflow = "auto";
            }

            // Import modal functions
            function openImportModal() {
                importModal.classList.remove("hidden");
                document.body.style.overflow = "hidden";
                importError.classList.add("hidden");
                importFileInput.value = "";
            }

            function closeImportModal() {
                importModal.classList.add("hidden");
                document.body.style.overflow = "auto";
                importError.classList.add("hidden");
            }

            // Event listeners for modals
            exportBtn.addEventListener("click", openExportModal);
            exportCancelBtn.addEventListener("click", closeExportModal);
            exportModalOverlay.addEventListener("click", closeExportModal);

            importBtn.addEventListener("click", openImportModal);
            importCancelBtn.addEventListener("click", closeImportModal);
            importModalOverlay.addEventListener("click", closeImportModal);

            // File input click handler
            document
                .querySelector("#importModal .border-dashed")
                .addEventListener("click", () => {
                    importFileInput.click();
                });

            // Export functions
            // Export functions - Version avec débogage
            exportMarkdownBtn.addEventListener("click", async () => {
                try {
                    console.log("Starting Markdown export...");

                    const { generateMarkdown } = await import(
                        "../lib/export_documents.js"
                    );
                    console.log("generateMarkdown function loaded");

                    const exportData = terms.map((term) => [
                        term.term,
                        term.definition,
                        Array.isArray(term.synonyms) ? term.synonyms : [],
                    ]);
                    console.log("Export data prepared:", exportData);

                    generateMarkdown(exportData);
                    console.log("Markdown export completed");

                    closeExportModal();
                    showSuccessMessage("Glossary exported as Markdown!");
                } catch (error) {
                    console.error("Export error details:", error);
                    console.error("Error stack:", error.stack);
                    showErrorMessage(
                        "Error exporting glossary: " + error.message,
                    );
                }
            });

            exportJsonBtn.addEventListener("click", async () => {
                try {
                    const { generateJSON } = await import(
                        "../lib/export_documents.js"
                    );

                    const exportData = terms.map((term) => [
                        term.term,
                        term.definition,
                        Array.isArray(term.synonyms) ? term.synonyms : [],
                    ]);

                    generateJSON(exportData);
                    closeExportModal();
                    showSuccessMessage("Glossary exported as JSON!");
                } catch (error) {
                    console.error("Export error:", error);
                    showErrorMessage("Error exporting glossary");
                }
            });

            // Import function
            importConfirmBtn.addEventListener("click", async () => {
                const file = importFileInput.files[0];

                if (!file) {
                    importError.textContent = "Please select a file";
                    importError.classList.remove("hidden");
                    return;
                }

                const fileExtension = file.name.split(".").pop().toLowerCase();

                if (!["md", "json"].includes(fileExtension)) {
                    importError.textContent =
                        "Please select a .md or .json file";
                    importError.classList.remove("hidden");
                    return;
                }

                try {
                    const fileContent = await readFileAsText(file);

                    if (fileExtension === "md") {
                        const { parseMarkdown } = await import(
                            "../lib/export_documents.js"
                        );
                        const parsedData = parseMarkdown(fileContent);
                        await importGlossaryData(parsedData);
                    } else {
                        const { parseJSON } = await import(
                            "../lib/export_documents.js"
                        );
                        const parsedData = parseJSON(fileContent);
                        await importGlossaryData(parsedData);
                    }

                    closeImportModal();
                    showSuccessMessage("Glossary imported successfully!");
                } catch (error) {
                    console.error("Import error:", error);
                    importError.textContent =
                        "Error importing file: " + error.message;
                    importError.classList.remove("hidden");
                }
            });

            // Helper function to read file as text
            function readFileAsText(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) =>
                        reject(new Error("Failed to read file"));
                    reader.readAsText(file);
                });
            }

            // Function to import glossary data
            async function importGlossaryData(parsedData) {
                if (!parsedData.data || !Array.isArray(parsedData.data)) {
                    throw new Error("Invalid file format");
                }

                // Clear existing terms or merge? Let's clear for now
                terms = [];
                nextId = 1;

                // Import new terms
                parsedData.data.forEach((row, index) => {
                    if (row.length >= 2) {
                        const term = row[0];
                        const definition = row[1];
                        let synonyms = [];

                        if (row.length >= 3) {
                            synonyms = Array.isArray(row[2])
                                ? row[2]
                                : typeof row[2] === "string"
                                  ? row[2]
                                        .split(",")
                                        .map((s) => s.trim())
                                        .filter((s) => s)
                                  : [];
                        }

                        terms.push({
                            id: nextId++,
                            term,
                            definition,
                            synonyms,
                        });
                    }
                });

                saveTerms();
                renderTable();
            }
            // Load terms from localStorage or use defaults
            let terms = JSON.parse(localStorage.getItem("glossaryTerms")) || [];
            let nextId = Math.max(...terms.map((t) => t.id), 0) + 1;
            let currentSynonyms = [];

            // Save terms to localStorage
            function saveTerms() {
                localStorage.setItem("glossaryTerms", JSON.stringify(terms));
            }

            // Render table
            function renderTable() {
                const tbody = document.getElementById("glossaryTable");
                tbody.innerHTML = terms
                    .map(
                        (term) => `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4 font-medium text-gray-900">${term.term}</td>
                    <td class="px-6 py-4 text-gray-700">${term.definition}</td>
                    <td class="px-6 py-4 text-gray-700">${Array.isArray(term.synonyms) ? term.synonyms.join(", ") : term.synonyms}</td>
                </tr>
            `,
                    )
                    .join("");
            }

            // Render synonym tags
            function renderSynonymTags() {
                const tagsContainer = document.getElementById("synonymTags");
                tagsContainer.innerHTML = currentSynonyms
                    .map(
                        (syn, index) => `
                <span class="inline-flex items-center gap-2 px-3 py-1 bg-gray-200 text-gray-800 rounded-md text-sm">
                    ${syn}
                    <button onclick="removeSynonym(${index})" class="text-gray-600 hover:text-gray-900 font-bold">×</button>
                </span>
            `,
                    )
                    .join("");
            }

            // Remove synonym
            window.removeSynonym = function (index) {
                currentSynonyms.splice(index, 1);
                renderSynonymTags();
            };

            // Add synonym from input
            function addSynonymFromInput() {
                const synonymInput = document.getElementById("synonymInput");
                const termInput = document.getElementById("termInput");
                const synonymError = document.getElementById("synonymError");
                const synonym = synonymInput.value.trim();
                const term = termInput.value.trim();

                // Clear previous error
                synonymError.classList.add("hidden");
                synonymInput.classList.remove("border-red-500");

                if (!synonym) return;

                // Check if synonym equals the term
                if (synonym.toLowerCase() === term.toLowerCase()) {
                    synonymError.textContent =
                        "The synonym cannot be identical to the term!";
                    synonymError.classList.remove("hidden");
                    synonymInput.classList.add("border-red-500");
                    return;
                }

                // Check if synonym already exists
                if (currentSynonyms.includes(synonym)) {
                    synonymError.textContent =
                        "This synonym has already been added!";
                    synonymError.classList.remove("hidden");
                    synonymInput.classList.add("border-red-500");
                    return;
                }

                currentSynonyms.push(synonym);
                renderSynonymTags();
                synonymInput.value = "";
            }

            // Clear all errors
            function clearErrors() {
                document.getElementById("termError").classList.add("hidden");
                document
                    .getElementById("definitionError")
                    .classList.add("hidden");
                document.getElementById("synonymError").classList.add("hidden");
                document
                    .getElementById("termInput")
                    .classList.remove("border-red-500");
                document
                    .getElementById("definitionInput")
                    .classList.remove("border-red-500");
                document
                    .getElementById("synonymInput")
                    .classList.remove("border-red-500");
            }

            // Modal functions
            const modal = document.getElementById("modal");
            const addTermBtn = document.getElementById("addTermBtn");
            const cancelBtn = document.getElementById("cancelBtn");
            const submitBtn = document.getElementById("submitBtn");
            const modalOverlay = document.getElementById("modalOverlay");
            const suggestBtn = document.getElementById("suggestBtn");
            const toast = document.getElementById("toast");
            const synonymInput = document.getElementById("synonymInput");

            function openModal() {
                modal.classList.remove("hidden");
                document.body.style.overflow = "hidden";
            }

            function closeModal() {
                modal.classList.add("hidden");
                document.body.style.overflow = "auto";
                // Clear inputs and tags
                document.getElementById("termInput").value = "";
                document.getElementById("definitionInput").value = "";
                document.getElementById("synonymInput").value = "";
                currentSynonyms = [];
                aiSuggestions = []; // Vider les suggestions IA
                renderSynonymTags();
                // Cacher le conteneur de suggestions IA
                document
                    .getElementById("aiSuggestionsContainer")
                    .classList.add("hidden");
                clearErrors();
            }

            let aiSuggestions = [];

            // Fonction pour afficher les suggestions IA cliquables
            function renderAISuggestions() {
                const container = document.getElementById(
                    "aiSuggestionsContainer",
                );

                if (aiSuggestions.length === 0) {
                    container.classList.add("hidden");
                    return;
                }

                // Filtrer les suggestions qui ne sont pas déjà dans les tags
                const availableSuggestions = aiSuggestions.filter(
                    (synonym) => !currentSynonyms.includes(synonym),
                );

                // Prendre 5 suggestions aléatoires maximum
                const randomSuggestions = availableSuggestions
                    .sort(() => 0.5 - Math.random())
                    .slice(0, 5);

                if (randomSuggestions.length === 0) {
                    container.classList.add("hidden");
                    return;
                }

                container.innerHTML = randomSuggestions
                    .map(
                        (synonym) => `
                        <button 
                            type="button" 
                            class="inline-flex items-center gap-1 px-3 py-1 bg-blue-100 text-blue-800 rounded-md text-sm hover:bg-blue-200 transition-colors ai-suggestion-btn"
                            data-synonym="${synonym.replace(/"/g, "&quot;")}"
                        >
                            ${synonym}
                            <span class="text-blue-600 text-xs">+</span>
                        </button>
                    `,
                    )
                    .join("");

                container.classList.remove("hidden");

                // Ajouter les événements click aux boutons de suggestion
                document
                    .querySelectorAll(".ai-suggestion-btn")
                    .forEach((btn) => {
                        btn.addEventListener("click", function () {
                            const synonym = this.getAttribute("data-synonym");
                            addAISuggestion(synonym);
                        });
                    });
            }

            // Fonction pour ajouter une suggestion IA aux tags
            function addAISuggestion(synonym) {
                const termInput = document.getElementById("termInput");
                const term = termInput.value.trim();

                // Vérifier que le synonyme n'est pas identique au terme
                if (synonym.toLowerCase() === term.toLowerCase()) {
                    return;
                }

                // Vérifier que le synonyme n'est pas déjà présent
                if (!currentSynonyms.includes(synonym)) {
                    currentSynonyms.push(synonym);
                    renderSynonymTags();
                    // Re-rendre les suggestions pour enlever celle qui a été ajoutée
                    renderAISuggestions();
                }
            }

            // Fonction pour récupérer les suggestions IA
            async function fetchAISuggestions() {
                const termInput = document.getElementById("termInput");
                const definitionInput =
                    document.getElementById("definitionInput");
                const synonymInput = document.getElementById("synonymInput");
                const suggestBtn = document.getElementById("suggestBtn");
                const aiSuggestionsContainer = document.getElementById(
                    "aiSuggestionsContainer",
                );

                const term = termInput.value.trim();
                const definition = definitionInput.value.trim();
                const synonyms = [
                    ...currentSynonyms,
                    synonymInput.value.trim(),
                ];

                if (!term) {
                    showErrorMessage("Please enter a word first.");
                    termInput.focus();
                    return;
                }

                // Afficher un indicateur de chargement
                const originalText = suggestBtn.textContent;
                suggestBtn.textContent = "Searching...";
                suggestBtn.disabled = true;

                // Masquer les anciennes suggestions pendant le chargement
                aiSuggestionsContainer.classList.add("hidden");

                try {
                    const response = await fetch("/api/suggest", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            term: term,
                            definition: definition,
                            synonyms: synonyms,
                        }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(
                            errorData.detail || "Erreur lors de la requête",
                        );
                    }

                    const data = await response.json();

                    if (data.synonyms && data.synonyms.length > 0) {
                        // Stocker toutes les suggestions
                        aiSuggestions = data.synonyms;
                        // Afficher les suggestions cliquables
                        renderAISuggestions();
                        showSuccessMessage(
                            `${data.synonyms.length} suggestions found`,
                        );
                    } else {
                        aiSuggestions = [];
                        showInfoMessage("No synonyms found for this word");
                    }
                } catch (error) {
                    console.error("Error:", error);
                    showErrorMessage("Error: " + error.message);
                    aiSuggestions = [];
                } finally {
                    // Restaurer le bouton
                    suggestBtn.textContent = originalText;
                    suggestBtn.disabled = false;
                }
            }

            // Event listeners
            addTermBtn.addEventListener("click", openModal);
            cancelBtn.addEventListener("click", closeModal);
            modalOverlay.addEventListener("click", closeModal);
            suggestBtn.addEventListener("click", fetchAISuggestions);

            // Add synonym on Enter key
            synonymInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    addSynonymFromInput();
                }
            });

            // Clear synonym error when typing
            synonymInput.addEventListener("input", () => {
                document.getElementById("synonymError").classList.add("hidden");
                synonymInput.classList.remove("border-red-500");
            });

            // Clear errors when typing in required fields
            document
                .getElementById("termInput")
                .addEventListener("input", () => {
                    document
                        .getElementById("termError")
                        .classList.add("hidden");
                    document
                        .getElementById("termInput")
                        .classList.remove("border-red-500");
                });

            document
                .getElementById("definitionInput")
                .addEventListener("input", () => {
                    document
                        .getElementById("definitionError")
                        .classList.add("hidden");
                    document
                        .getElementById("definitionInput")
                        .classList.remove("border-red-500");
                });

            submitBtn.addEventListener("click", () => {
                const termInput = document.getElementById("termInput");
                const definitionInput =
                    document.getElementById("definitionInput");
                const term = termInput.value.trim();
                const definition = definitionInput.value.trim();

                // Clear previous errors
                clearErrors();

                let hasError = false;

                // Validate term
                if (!term) {
                    document
                        .getElementById("termError")
                        .classList.remove("hidden");
                    termInput.classList.add("border-red-500");
                    hasError = true;
                }

                // Validate definition
                if (!definition) {
                    document
                        .getElementById("definitionError")
                        .classList.remove("hidden");
                    definitionInput.classList.add("border-red-500");
                    hasError = true;
                }

                if (hasError) return;

                terms.push({
                    id: nextId++,
                    term,
                    definition,
                    synonyms:
                        currentSynonyms.length > 0 ? [...currentSynonyms] : [],
                });
                saveTerms();
                renderTable();
                closeModal();
            });

            // Close modal on Escape key
            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape" && !modal.classList.contains("hidden")) {
                    closeModal();
                }
            });

            // Fonctions pour afficher différents types de messages
            function showSuccessMessage(message) {
                showMessage(
                    message,
                    "bg-green-100 border-green-400 text-green-700",
                );
            }

            function showErrorMessage(message) {
                showMessage(message, "bg-red-100 border-red-400 text-red-700");
            }

            function showInfoMessage(message) {
                showMessage(
                    message,
                    "bg-blue-100 border-blue-400 text-blue-700",
                );
            }

            function showMessage(message, styles) {
                // Créer ou réutiliser la toast
                let toast = document.getElementById("aiToast");
                if (!toast) {
                    toast = document.createElement("div");
                    toast.id = "aiToast";
                    toast.className = `fixed top-4 right-4 border rounded-lg shadow-lg p-4 z-50 transition-opacity duration-300 ${styles}`;
                    document.body.appendChild(toast);
                }

                toast.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="flex-1">
                            <p class="font-medium">${message}</p>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="text-gray-500 hover:text-gray-700">
                            ×
                        </button>
                    </div>
                `;

                // Auto-suppression après 5 secondes
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.remove();
                    }
                }, 5000);
            }

            // Permettre d'appuyer sur Entrée dans le champ synonyme pour ajouter
            synonymInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    addSynonymFromInput();
                }
            });

            // Initial render
            renderTable();
        </script>
    </body>
</html>
